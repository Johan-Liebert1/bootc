#!/bin/bash

set -eux

cd "${0%/*}"

FROM="${FROM:-quay.io/fedora/fedora-bootc:42}"
TAG="${TAG:-quay.io/fedora/fedora-bootc-base-uki:42}"
EXTRA="${EXTRA:-extra}"

# cargo build --release --features=composefs-backend

mkdir -p "${EXTRA}/usr/bin/"
cp ../../target/release/bootc "${EXTRA}/usr/bin/"
cp ../../target/release/bootc-initramfs-setup "${EXTRA}/usr/lib/dracut/modules.d/37bootc/"

mkdir -p tmp

podman build \
    --from "${FROM}" \
    -t "${TAG}" \
    -f Containerfile.stage1 \
    --iidfile=tmp/iid \
    "${EXTRA}"
